name: Create Event PR from Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  create-pr:
    # Only run if issue has 'new-event' label
    if: contains(github.event.issue.labels.*.name, 'new-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        run: |
          # Get issue body
          ISSUE_BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          
          # Extract fields using grep and sed
          YEAR=$(echo "$ISSUE_BODY" | grep -A1 "### YÄ±l" | tail -n1 | xargs)
          TITLE=$(echo "$ISSUE_BODY" | grep -A1 "### BaÅŸlÄ±k" | tail -n1 | xargs)
          DESCRIPTION=$(echo "$ISSUE_BODY" | grep -A1 "### AÃ§Ä±klama" | tail -n1 | xargs)
          CATEGORY=$(echo "$ISSUE_BODY" | grep -A1 "### Kategori" | tail -n1 | xargs)
          DATE=$(echo "$ISSUE_BODY" | grep -A1 "### Tam Tarih" | tail -n1 | xargs)
          
          # Use current date if not provided
          if [ -z "$DATE" ] || [ "$DATE" = "_No response_" ]; then
            DATE="$YEAR-01-01"
          fi
          
          # Sanitize category
          if [ -z "$CATEGORY" ] || [ "$CATEGORY" = "_No response_" ] || [ "$CATEGORY" = "None" ]; then
            CATEGORY="diÄŸer"
          fi
          
          # Create slug for filename (remove special chars, replace spaces with -)
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          FILENAME="${YEAR}-${SLUG}.md"
          
          # Output variables
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Parsed:"
          echo "  Year: $YEAR"
          echo "  Title: $TITLE"
          echo "  Category: $CATEGORY"
          echo "  Date: $DATE"
          echo "  Filename: $FILENAME"

      - name: Create markdown file
        run: |
          # Create events/data directory if doesn't exist
          mkdir -p events/data
          
          # Create markdown file
          cat > "events/data/${{ steps.parse.outputs.filename }}" << 'MDEOF'
          ---
          year: ${{ steps.parse.outputs.year }}
          title: "${{ steps.parse.outputs.title }}"
          date: ${{ steps.parse.outputs.date }}
          category: ${{ steps.parse.outputs.category }}
          ---
          
          ${{ steps.parse.outputs.description }}
          MDEOF
          
          echo "âœ… Created: events/data/${{ steps.parse.outputs.filename }}"
          cat "events/data/${{ steps.parse.outputs.filename }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add event: ${{ steps.parse.outputs.title }} (${{ steps.parse.outputs.year }})"
          branch: event/${{ github.event.issue.number }}
          delete-branch: true
          title: "âœ¨ Yeni Olay: ${{ steps.parse.outputs.title }}"
          body: |
            ## ðŸ“… Yeni Olay Eklendi
            
            **Issue:** #${{ github.event.issue.number }}
            **YÄ±l:** ${{ steps.parse.outputs.year }}
            **Tarih:** ${{ steps.parse.outputs.date }}
            **Kategori:** ${{ steps.parse.outputs.category }}
            
            ### ðŸ“ BaÅŸlÄ±k
            ${{ steps.parse.outputs.title }}
            
            ### ðŸ“– AÃ§Ä±klama
            ${{ steps.parse.outputs.description }}
            
            ---
            
            Bu PR, issue #${{ github.event.issue.number }} tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **Dosya:** `events/data/${{ steps.parse.outputs.filename }}`
            
            ### âœ… Onaylamak iÃ§in:
            1. DeÄŸiÅŸiklikleri gÃ¶zden geÃ§irin
            2. "Merge pull request" butonuna tÄ±klayÄ±n
            3. Issue otomatik kapatÄ±lacak
            
            ### âŒ Reddetmek iÃ§in:
            1. PR'Ä± kapatÄ±n
            2. Issue'ya yorum bÄ±rakÄ±n
          labels: |
            event
            automated
        id: create-pr

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ Harika! OlayÄ±nÄ±z iÃ§in otomatik olarak bir Pull Request oluÅŸturuldu!\n\nðŸ”— **PR:** #${{ steps.create-pr.outputs.pull-request-number }}\n\nâœ… OnaylandÄ±ktan sonra timeline'da gÃ¶rÃ¼necek.`
            })

      - name: Close issue when PR merged
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            // Find linked issue
            const prBody = context.payload.pull_request.body;
            const issueMatch = prBody.match(/#(\d+)/);
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âœ… Olay timeline\'a eklendi! ðŸŽ‰'
              });
            }
