name: 13 - Olay Silme PR OluÅŸturucu

on:
  issues:
    types: [closed]

jobs:
  create-delete-pr:
    if: contains(github.event.issue.labels.*.name, 'delete-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "=== DELETE ISSUE PARSE BAÅLADI ==="
          
          # DeÄŸiÅŸkenleri baÅŸlat
          FILENAME=""
          REASON=""
          
          # Issue body'yi satÄ±r satÄ±r oku
          current_section=""
          content=""
          
          while IFS= read -r line; do
            if [[ "$line" =~ ^###[[:space:]](.+) ]]; then
              if [[ -n "$current_section" ]]; then
                # --- DÃœZELTÄ°LDÄ°: 'id' ile eÅŸleÅŸen 'label' kullanÄ±lmalÄ± ---
                case "$current_section" in
                  "Dosya AdÄ± (Zorunlu)")
                    FILENAME="$content"
                    ;;
                  "Silme GerekÃ§esi")
                    REASON="$content"
                    ;;
                esac
              fi
              current_section="${BASH_REMATCH[1]}"
              content=""
            elif [[ -n "$line" && ! "$line" =~ ^-[[:space:]]\[.?\] ]]; then
              if [[ -n "$content" ]]; then
                content="$content"$'\n'"$line"
              else
                content="$line"
              fi
            fi
          done <<< "$ISSUE_BODY"
          
          # Son bÃ¶lÃ¼mÃ¼ de kaydet
          if [[ -n "$current_section" ]]; then
            case "$current_section" in
              "Dosya AdÄ± (Zorunlu)")
                FILENAME="$content"
                ;;
              "Silme GerekÃ§esi")
                REASON="$content"
                ;;
            esac
          fi
          
          FILENAME=$(echo "$FILENAME" | tr -d '\r' | xargs)
          REASON=$(echo "$REASON" | tr -d '\r' | xargs)
          
          echo "Dosya adÄ±: $FILENAME"
          echo "Silme nedeni: $REASON"
          
          if [[ -z "$FILENAME" || "$FILENAME" == "_No response_" ]]; then
             echo "âŒ HATA: Issue body iÃ§inde 'Dosya AdÄ± (Zorunlu)' alanÄ± bulunamadÄ± veya boÅŸ."
             echo "file_exists=false" >> $GITHUB_OUTPUT
             echo "filename=NOT_FOUND" >> $GITHUB_OUTPUT
             exit 0
          fi

          if [[ ! -f "events/data/$FILENAME" ]]; then
            echo "âŒ HATA: Dosya bulunamadÄ±: events/data/$FILENAME"
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Dosya bulundu: events/data/$FILENAME"
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Delete file and create PR
        if: steps.parse.outputs.file_exists == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "ğŸ—‘ï¸ Olay sil: ${{ steps.parse.outputs.filename }}"
          branch: event/delete-${{ github.event.issue.number }}
          delete-branch: true
          title: "ğŸ—‘ï¸ Olay Sil: ${{ steps.parse.outputs.filename }}"
          body: |
            ## â›” Olay Silme Ä°steÄŸi
            
            **Issue:** #${{ github.event.issue.number }}
            **Silinecek Dosya:** `${{ steps.parse.outputs.filename }}`
            **Silme GerekÃ§esi:** ${{ steps.parse.outputs.reason }}
            
            ---
            âš ï¸ **DÄ°KKAT:** Bu iÅŸlem geri alÄ±namaz!
            
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak silme iÅŸlemini onaylayÄ±n.**
          
          prepare-script: |
            echo "Dosya siliniyor: events/data/${{ steps.parse.outputs.filename }}"
            if [ -f "events/data/${{ steps.parse.outputs.filename }}" ]; then
              git rm "events/data/${{ steps.parse.outputs.filename }}"
              echo "âœ… Dosya silindi"
            else
              echo "âŒ Dosya bulunamadÄ±!"
              exit 1
            fi
          
          labels: |
            event
            deletion
            automated
        id: create-pr

      - name: Comment on issue - Success
        if: steps.parse.outputs.file_exists == 'true' && steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Issue kapatÄ±ldÄ±. Silme iÅŸlemi iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ”— **PR:** #${{ steps.create-pr.outputs.pull-request-number }}\n\nâš ï¸ **UyarÄ±:** PR onaylandÄ±ÄŸÄ±nda olay kalÄ±cÄ± olarak silinecektir.`
            })

      - name: Comment on issue - File not found
        if: steps.parse.outputs.file_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **HATA:** \`${{ steps.parse.outputs.filename }}\` adÄ±nda bir dosya bulunamadÄ±. LÃ¼tfen dosya adÄ±nÄ± kontrol edip issue'yu yeniden aÃ§Ä±n.`
            })