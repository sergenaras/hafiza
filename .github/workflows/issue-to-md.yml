name: ⚙️ Issue to Markdown

on:
  issues:
    types:
      - labeled

jobs:
  create_md_from_issue:
    # Sadece "new-event" etiketine sahip issue'lar için çalış
    if: contains(github.event.issue.labels.*.name, 'new-event')
    runs-on: ubuntu-latest
    permissions:
      # Issue'ları okumak için
      issues: read
      # Kodu checkout yapmak ve commit atmak için
      contents: write
      # Başka bir workflow'u tetiklemek için
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: DEBUG - Print Issue Body
        run: |
          echo "The raw issue body is:"
          echo "------------------------------------"
          echo "${{ github.event.issue.body }}"
          echo "------------------------------------"

      - name: Extract data from issue form
        id: extract_data
        run: |
          body="${{ github.event.issue.body }}"
          # Use awk to skip blank lines after headers
          year=$(echo "$body" | awk '/### Yıl/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          title=$(echo "$body" | awk '/### Başlık/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          description=$(echo "$body" | awk '/### Açıklama/{f=1;next} /### Kategori/{f=0} f' | sed '/^[[:space:]]*$/d' | tr -d '\r')
          category=$(echo "$body" | awk '/### Kategori/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          date=$(echo "$body" | awk '/### Tam Tarih/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')

          echo "year=$year" >> "$GITHUB_OUTPUT"
          echo "title=$title" >> "$GITHUB_OUTPUT"
          echo "description=$description" >> "$GITHUB_OUTPUT"
          echo "category=$category" >> "$GITHUB_OUTPUT"
          echo "date=$date" >> "$GITHUB_OUTPUT"

      - name: Generate Markdown file
        id: generate_file
        env:
          YEAR: ${{ steps.extract_data.outputs.year }}
          TITLE: ${{ steps.extract_data.outputs.title }}
          DATE: ${{ steps.extract_data.outputs.date }}
          CATEGORY: ${{ steps.extract_data.outputs.category }}
          DESCRIPTION: ${{ steps.extract_data.outputs.description }}
        run: |
          # Dosya adı için başlığı temizle (küçük harf, boşluk yerine tire)
          filename_title=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/--+/-/g' -e 's/^-//' -e 's/-$//')
          filename="${YEAR}-${filename_title}.md"
          filepath="events/data/${filename}"

          # Güvenlik için 'heredoc' kullanarak dosyayı oluştur
          cat <<EOF > "$filepath"
          ---
          year: $YEAR
          title: "$TITLE"
          $(test -n "$DATE" && echo "date: $DATE")
          $(test -n "$CATEGORY" && echo "category: $CATEGORY")
          ---

          $DESCRIPTION
          EOF

          echo "filename=$filename" >> $GITHUB_OUTPUT
          echo "filepath=$filepath" >> $GITHUB_OUTPUT
          echo "✅ Markdown file generated at $filepath"

      - name: Commit and push new event file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "${{ steps.generate_file.outputs.filepath }}"
          # Değişiklik olup olmadığını kontrol et
          if git diff --staged --quiet; then
            echo "Commit atılacak yeni değişiklik bulunamadı."
          else
            git commit -m "✨ Yeni olay ekle: ${{ steps.extract_data.outputs.title }}" -m "Issue #${{ github.event.issue.number }} üzerinden eklendi."
            git push
          fi

      - name: Trigger 'Generate Events JSON' workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering 'Generate Events JSON' workflow..."
          gh workflow run generate-events.yml --ref ${{ github.event.repository.default_branch }}
