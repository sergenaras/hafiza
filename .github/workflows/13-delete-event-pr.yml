name: 13 - Olay Silme PR OluÅŸturucu

on:
  issues:
    types: [closed]

jobs:
  delete-event-pr:
    if: contains(github.event.issue.labels.*.name, 'delete-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse deletion request
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "=== PARSING DELETE REQUEST ==="
          
          # DeÄŸiÅŸkenleri baÅŸlat
          FILENAME_TO_DELETE=""
          EVENT_TITLE=""
          DELETION_REASON=""
          
          # Issue body'yi satÄ±r satÄ±r oku
          current_section=""
          content=""
          
          while IFS= read -r line; do
            # BaÅŸlÄ±k kontrolÃ¼ (### ile baÅŸlÄ±yor mu?)
            if [[ "$line" =~ ^###[[:space:]](.+) ]]; then
              # Ã–nceki bÃ¶lÃ¼mÃ¼ kaydet
              if [[ -n "$current_section" ]]; then
                case "$current_section" in
                  "Silinecek Dosya")
                    FILENAME_TO_DELETE="$content"
                    ;;
                  "Olay BaÅŸlÄ±ÄŸÄ±")
                    EVENT_TITLE="$content"
                    ;;
                  "Silme Nedeni")
                    DELETION_REASON="$content"
                    ;;
                esac
              fi
              
              # Yeni bÃ¶lÃ¼m baÅŸlat
              current_section="${BASH_REMATCH[1]}"
              content=""
            elif [[ -n "$line" && ! "$line" =~ ^-[[:space:]]\[.?\] ]]; then
              # Checkbox deÄŸilse ve boÅŸ satÄ±r deÄŸilse iÃ§eriÄŸe ekle
              if [[ -n "$content" ]]; then
                content="${content}
${line}"
              else
                content="$line"
              fi
            fi
          done <<< "$ISSUE_BODY"
          
          # Son bÃ¶lÃ¼mÃ¼ de kaydet
          if [[ -n "$current_section" ]]; then
            case "$current_section" in
              "Silinecek Dosya")
                FILENAME_TO_DELETE="$content"
                ;;
              "Olay BaÅŸlÄ±ÄŸÄ±")
                EVENT_TITLE="$content"
                ;;
              "Silme Nedeni")
                DELETION_REASON="$content"
                ;;
            esac
          fi
          
          # Temizlik
          FILENAME_TO_DELETE=$(echo "$FILENAME_TO_DELETE" | tr -d '\r' | xargs)
          EVENT_TITLE=$(echo "$EVENT_TITLE" | tr -d '\r' | xargs)
          DELETION_REASON=$(echo "$DELETION_REASON" | tr -d '\r')
          
          # Dosya kontrolÃ¼
          if [[ ! -f "events/data/$FILENAME_TO_DELETE" ]]; then
            echo "âŒ HATA: Dosya bulunamadÄ±: events/data/$FILENAME_TO_DELETE"
            echo "file_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Dosya bulundu: events/data/$FILENAME_TO_DELETE"
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME_TO_DELETE" >> $GITHUB_OUTPUT
          echo "event_title=$EVENT_TITLE" >> $GITHUB_OUTPUT
          echo "deletion_reason<<EOF" >> $GITHUB_OUTPUT
          echo "$DELETION_REASON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Delete event file
        if: steps.parse.outputs.file_exists == 'true'
        run: |
          rm "events/data/${{ steps.parse.outputs.filename }}"
          echo "âœ… Dosya silindi: events/data/${{ steps.parse.outputs.filename }}"

      - name: Create Pull Request
        if: steps.parse.outputs.file_exists == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "ğŸ—‘ï¸ Olay sil: ${{ steps.parse.outputs.event_title }}"
          branch: delete-event/${{ github.event.issue.number }}
          delete-branch: true
          title: "ğŸ—‘ï¸ Olay Silme: ${{ steps.parse.outputs.event_title }}"
          body: |
            ## ğŸ—‘ï¸ Olay Silme Ä°steÄŸi
            
            **Issue:** #${{ github.event.issue.number }}
            **Silinecek Dosya:** `${{ steps.parse.outputs.filename }}`
            **Olay BaÅŸlÄ±ÄŸÄ±:** ${{ steps.parse.outputs.event_title }}
            
            ### Silme Nedeni:
            ${{ steps.parse.outputs.deletion_reason }}
            
            ---
            âš ï¸ **DÄ°KKAT:** Bu iÅŸlem geri alÄ±namaz! 
            
            Bu PR, issue #${{ github.event.issue.number }} tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **Silme iÅŸlemini onaylamak iÃ§in "Merge pull request" butonuna basÄ±n.**
          
          labels: |
            event
            deletion
            automated
        id: create-pr

      - name: Comment on issue - Success
        if: steps.parse.outputs.file_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Silme isteÄŸi alÄ±ndÄ±. Onay iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ”— **PR:** #${{ steps.create-pr.outputs.pull-request-number }}\n\nâš ï¸ **UyarÄ±:** PR onaylandÄ±ÄŸÄ±nda olay kalÄ±cÄ± olarak silinecektir.`
            })

      - name: Comment on issue - File not found
        if: steps.parse.outputs.file_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **HATA:** Belirtilen dosya bulunamadÄ±!\n\nDosya adÄ±: \`${{ steps.parse.outputs.filename }}\`\n\nLÃ¼tfen dosya adÄ±nÄ±n doÄŸru olduÄŸundan emin olun ve tekrar deneyin.`
            })
