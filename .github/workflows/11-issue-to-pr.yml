name: 11 - Olay PR OluÅŸturucu (JSON Format)

on:
  issues:
    types: [closed]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Check labels and skip if not supported
        id: check_labels
        run: |
          LABELS_JSON='${{ toJSON(github.event.issue.labels) }}'
          if echo "$LABELS_JSON" | grep -q '"name":"new-event"' || echo "$LABELS_JSON" | grep -q '"name":"upgrade-event"' || echo "$LABELS_JSON" | grep -q '"name":"delete-event"'; then
            echo "continue=true" >> $GITHUB_OUTPUT
          else
            echo "continue=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if not supported label
        if: steps.check_labels.outputs.continue == 'false'
        run: |
          echo "Bu issue desteklenmeyen etiket taÅŸÄ±yor. Ä°ÅŸlem iptal ediliyor."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse JSON data from issue body
        id: parse_json
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "=== ISSUE BODY START ==="
          echo "$ISSUE_BODY"
          echo "=== ISSUE BODY END ==="
          
          JSON_DATA=""
          BASE64_DATA=""
          OPERATION_TYPE=""
          
          # EVENT JSON verisi
          if echo "$ISSUE_BODY" | grep -q 'EVENT_JSON_DATA_BASE64:'; then
            echo "ğŸ“¦ EVENT JSON verisi bulundu"
            # Kod bloÄŸundan (```) base64 verisini Ã§Ä±kar
            BASE64_DATA=$(echo "$ISSUE_BODY" | grep -oP 'EVENT_JSON_DATA_BASE64:\K[^\s`]+' | head -1)
            
            if [ -z "$BASE64_DATA" ]; then
              echo "âŒ Base64 verisi Ã§Ä±karÄ±lamadÄ± (EVENT)"
              exit 1
            fi
            
            if ! JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null); then
              echo "âŒ Base64 decode hatasÄ±"
              exit 1
            fi
            
            OPERATION_TYPE="event"
          
          # DELETE JSON verisi  
          elif echo "$ISSUE_BODY" | grep -q 'DELETE_JSON_DATA_BASE64:'; then
            echo "ğŸ—‘ï¸ DELETE JSON verisi bulundu"
            # Kod bloÄŸundan (```) base64 verisini Ã§Ä±kar
            BASE64_DATA=$(echo "$ISSUE_BODY" | grep -oP 'DELETE_JSON_DATA_BASE64:\K[^\s`]+' | head -1)

            if [ -z "$BASE64_DATA" ]; then
              echo "âŒ Base64 verisi Ã§Ä±karÄ±lamadÄ± (DELETE)"
              exit 1
            fi

            if ! JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null); then
              echo "âŒ Base64 decode hatasÄ±"
              exit 1
            fi
            
            OPERATION_TYPE="delete"
          
          else
            echo "âŒ JSON verisi bulunamadÄ±. Issue body'de 'EVENT_JSON_DATA_BASE64:' veya 'DELETE_JSON_DATA_BASE64:' anahtarÄ± yok."
            echo "OPERATION_TYPE=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“„ JSON Data: $JSON_DATA"
          
          # jq ile parse et
          TITLE=$(echo "$JSON_DATA" | jq -r '.title // ""')
          DATE=$(echo "$JSON_DATA" | jq -r '.date // ""')
          TIME=$(echo "$JSON_DATA" | jq -r '.time // ""')
          CATEGORY=$(echo "$JSON_DATA" | jq -r '.category // ""')
          DESCRIPTION=$(echo "$JSON_DATA" | jq -r '.description // ""')
          SOURCES=$(echo "$JSON_DATA" | jq -r '.sources // ""')
          TYPE=$(echo "$JSON_DATA" | jq -r '.type // ""')
          ORIGINAL_FILENAME=$(echo "$JSON_DATA" | jq -r '.original_filename // ""')
          FILENAME_TO_DELETE=$(echo "$JSON_DATA" | jq -r '.filename // ""')
          
          # VarsayÄ±lan deÄŸerler
          TITLE="${TITLE:-BaÅŸlÄ±ksÄ±z Olay}"
          DATE="${DATE:-$(date +%Y-%m-%d)}"
          CATEGORY="${CATEGORY:-diÄŸer}"
          DESCRIPTION="${DESCRIPTION:-AÃ§Ä±klama eklenmedi}"
          SOURCES="${SOURCES:-}"
          
          # Dosya adÄ± oluÅŸtur
          if [[ "$OPERATION_TYPE" == "event" ]]; then
            if [[ "$TYPE" == "edit" && -n "$ORIGINAL_FILENAME" ]]; then
              FILENAME="$ORIGINAL_FILENAME"
              echo "ğŸ“ DÃ¼zenleme iÅŸlemi: $FILENAME"
            else
              SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | \
                     sed -e 's/Ã§/c/g' -e 's/ÄŸ/g/g' -e 's/Ä±/i/g' \
                         -e 's/Ã¶/o/g' -e 's/ÅŸ/s/g' -e 's/Ã¼/u/g' \
                         -e 's/Ã‡/c/g' -e 's/Ä/g/g' -e 's/I/i/g' \
                         -e 's/Ä°/i/g' -e 's/Ã–/o/g' -e 's/Å/s/g' \
                         -e 's/Ãœ/u/g' | \
                     sed -e 's/[^a-z0-9]/-/g' -e 's/--*/-/g' -e 's/^-//' -e 's/-$//')
              FILENAME="${DATE}-${SLUG}.md"
              echo "ğŸ†• Yeni olay: $FILENAME"
            fi
          elif [[ "$OPERATION_TYPE" == "delete" ]]; then
            FILENAME="$FILENAME_TO_DELETE"
            echo "ğŸ—‘ï¸ Silinecek dosya: $FILENAME"
          fi
          
          # === DÃœZELTME BAÅLANGICI: GÃ¼venli multiline output ===
          # GitHub Output'a yaz
          echo "OPERATION_TYPE=$OPERATION_TYPE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          
          # $DESCRIPTION deÄŸiÅŸkeni Ã§ok satÄ±rlÄ± olabileceÄŸi iÃ§in
          # bu 'grouping' yÃ¶ntemi ( { ... } >> file ) kullanÄ±lmalÄ±dÄ±r.
          {
            echo "description<<EOF"
            echo "$DESCRIPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # $SOURCES deÄŸiÅŸkeni de Ã§ok satÄ±rlÄ± olabilir
          {
            echo "sources<<EOF"
            echo "$SOURCES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "original_filename=$ORIGINAL_FILENAME" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          # === DÃœZELTME BÄ°TÄ°ÅÄ° ===
          
          echo "=== PARSED VALUES ==="
          echo "OPERATION_TYPE: $OPERATION_TYPE"
          echo "TITLE: $TITLE"
          echo "DATE: $DATE"
          echo "CATEGORY: $CATEGORY"
          echo "FILENAME: $FILENAME"
          echo "TYPE: $TYPE"
          echo "===================="

      - name: Create or update event file
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event'
        run: |
          mkdir -p events/data
          
          echo "Dosya iÅŸleniyor: events/data/${{ steps.parse_json.outputs.filename }}"
          
          cat > "events/data/${{ steps.parse_json.outputs.filename }}" << MDEOF
          ---
          title: "${{ steps.parse_json.outputs.title }}"
          date: "${{ steps.parse_json.outputs.date }}"
          time: "${{ steps.parse_json.outputs.time }}"
          category: "${{ steps.parse_json.outputs.category }}"
          ---

          ${{ steps.parse_json.outputs.description }}

          ## Kaynaklar
          ${{ steps.parse_json.outputs.sources }}
          MDEOF
          
          echo "âœ… Dosya oluÅŸturuldu/gÃ¼ncellendi: events/data/${{ steps.parse_json.outputs.filename }}"
          echo "--- DOSYA Ä°Ã‡ERÄ°ÄÄ° ---"
          cat "events/data/${{ steps.parse_json.outputs.filename }}"
          echo "--- SON ---"

      - name: Delete event file
        if: steps.parse_json.outputs.OPERATION_TYPE == 'delete'
        run: |
          echo "Silinecek dosya: events/data/${{ steps.parse_json.outputs.filename }}"
          
          if [ -f "events/data/${{ steps.parse_json.outputs.filename }}" ]; then
            rm "events/data/${{ steps.parse_json.outputs.filename }}"
            echo "âœ… Dosya silindi: events/data/${{ steps.parse_json.outputs.filename }}"
          else
            echo "âŒ UyarÄ±: Dosya bulunamadÄ±: events/data/${{ steps.parse_json.outputs.filename }}. Belki zaten silinmiÅŸtir."
          fi

      - name: Create Pull Request for Edit Event
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event' && steps.parse_json.outputs.type == 'edit'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "ğŸ“ Olay gÃ¼ncelle: ${{ steps.parse_json.outputs.title }}"
          branch: update-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "ğŸ“ Olay GÃ¼ncelleme: ${{ steps.parse_json.outputs.title }}"
          body: |
            ## ğŸ“… Olay GÃ¼ncellendi
            
            **Issue:** #${{ github.event.issue.number }}
            **Dosya:** `${{ steps.parse_json.outputs.filename }}`
            **Tarih:** ${{ steps.parse_json.outputs.date }}
            **Kategori:** ${{ steps.parse_json.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak onaylayÄ±n.**
          labels: |
            event
            automated
            update

      - name: Create Pull Request for New Event
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event' && steps.parse_json.outputs.type != 'edit'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "âœ¨ Yeni olay ekle: ${{ steps.parse_json.outputs.title }}"
          branch: new-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "âœ¨ Yeni Olay: ${{ steps.parse_json.outputs.title }}"
          body: |
            ## ğŸ“… Olay Eklendi
            
            **Issue:** #${{ github.event.issue.number }}
            **Dosya:** `${{ steps.parse_json.outputs.filename }}`
            **Tarih:** ${{ steps.parse_json.outputs.date }}
            **Kategori:** ${{ steps.parse_json.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak onaylayÄ±n.**
          labels: |
            event
            automated
            new

      - name: Create Pull Request for Delete
        if: steps.parse_json.outputs.OPERATION_TYPE == 'delete'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "ğŸ—‘ï¸ Olay sil: ${{ steps.parse_json.outputs.filename }}"
          branch: delete-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "ğŸ—‘ï¸ Olay Sil: ${{ steps.parse_json.outputs.filename }}"
          body: |
            ## â›” Olay Silme Ä°steÄŸi
            
            **Issue:** #${{ github.event.issue.number }}
            **Silinen Dosya:** `${{ steps.parse_json.outputs.filename }}`
            
            ---
            âš ï¸ **DÄ°KKAT:** Bu iÅŸlem geri alÄ±namaz!
            
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak silme iÅŸlemini onaylayÄ±n.**
          labels: |
            event
            deletion
            automated

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const operationType = '${{ steps.parse_json.outputs.OPERATION_TYPE }}';
            const eventType = '${{ steps.parse_json.outputs.type }}';
            
            let prNumber;
            let message;
            
            if (operationType === 'event') {
              if (eventType === 'edit') {
                message = `âœ… Issue kapatÄ±ldÄ±. Olay gÃ¼ncelleme iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ“ **Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
              } else {
                message = `âœ… Issue kapatÄ±ldÄ±. Yeni olay iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ“ **Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
              }
            } else {
              message = `âœ… Issue kapatÄ±ldÄ±. Silme iÅŸlemi iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ—‘ï¸ **Silinen Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });