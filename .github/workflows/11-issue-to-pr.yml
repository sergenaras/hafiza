name: 11 - Olay PR OluÅŸturucu (Yeni/DÃ¼zenle)

on:
  issues:
    types: [closed]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'new-event') || contains(github.event.issue.labels.*.name, 'upgrade-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check labels and determine operation type
        id: check_labels
        run: |
          # Labels'Ä± JSON formatÄ±nda al
          LABELS_JSON='${{ toJSON(github.event.issue.labels) }}'
          echo "Labels JSON: $LABELS_JSON"
          
          # upgrade-event etiketi var mÄ± kontrol et
          if echo "$LABELS_JSON" | grep -q '"name":"upgrade-event"'; then
            echo "ğŸ”„ DÃ¼zenleme iÅŸlemi tespit edildi"
            echo "IS_EDIT=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ†• Yeni olay iÅŸlemi tespit edildi"
            echo "IS_EDIT=false" >> $GITHUB_OUTPUT
          fi

      - name: Parse issue body and URL parameters
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: '${{ github.event.issue.html_url }}'
        run: |
          echo "=== ISSUE BODY START ==="
          echo "$ISSUE_BODY"
          echo "=== ISSUE BODY END ==="
          
          # DeÄŸiÅŸkenleri baÅŸlat
          TITLE=""
          DATE=""
          TIME=""
          CATEGORY_MAIN=""
          CATEGORY_OTHER=""
          DESCRIPTION_RAW=""
          SOURCES_RAW=""
          ORIGINAL_FILENAME=""
          
          # DÃ¼zenleme mi yeni mi? check_labels step'inden al
          IS_EDIT="${{ steps.check_labels.outputs.IS_EDIT }}"
          echo "IS_EDIT: $IS_EDIT"
          
          if [ "$IS_EDIT" = "true" ]; then
            echo "ğŸ”„ DÃ¼zenleme iÅŸlemi - Orijinal dosya adÄ± aranÄ±yor..."
            
            # URL'den original_filename parametresini Ã§ek
            ORIGINAL_FILENAME=$(echo "$ISSUE_URL" | grep -o 'original_filename=[^&]*' | cut -d'=' -f2 || echo "")
            if [[ -n "$ORIGINAL_FILENAME" ]]; then
              # URL decode iÅŸlemi
              ORIGINAL_FILENAME=$(echo "$ORIGINAL_FILENAME" | sed 's/+/ /g; s/%/\\x/g')
              ORIGINAL_FILENAME=$(printf "%b" "$ORIGINAL_FILENAME" 2>/dev/null || echo "$ORIGINAL_FILENAME")
              echo "ğŸ“ Orijinal dosya adÄ± bulundu: $ORIGINAL_FILENAME"
            else
              echo "âš ï¸ Orijinal dosya adÄ± bulunamadÄ±, yeni dosya oluÅŸturulacak"
            fi
          else
            echo "ğŸ†• Yeni olay iÅŸlemi"
          fi
          
          # Issue body'yi satÄ±r satÄ±r oku
          current_section=""
          content=""
          
          while IFS= read -r line; do
            # BaÅŸlÄ±k kontrolÃ¼ (### ile baÅŸlÄ±yor mu?)
            if [[ "$line" =~ ^###[[:space:]](.+) ]]; then
              # Ã–nceki bÃ¶lÃ¼mÃ¼ kaydet
              if [[ -n "$current_section" ]]; then
                case "$current_section" in
                  "BaÅŸlÄ±k")
                    TITLE="$content"
                    ;;
                  "Tam Tarih (YYYY-AA-GG)")
                    DATE="$content"
                    ;;
                  "Saat (SS:DD) - Ä°steÄŸe baÄŸlÄ±")
                    TIME="$content"
                    ;;
                  "Kategori")
                    CATEGORY_MAIN="$content"
                    ;;
                  "Ã–zel Kategori (EÄŸer 'DiÄŸer' SeÃ§tiyseniz)")
                    CATEGORY_OTHER="$content"
                    ;;
                  "AÃ§Ä±klama")
                    DESCRIPTION_RAW="$content"
                    ;;
                  "Kaynaklar")
                    SOURCES_RAW="$content"
                    ;;
                esac
              fi
              
              current_section="${BASH_REMATCH[1]}"
              content=""
            elif [[ -n "$line" && ! "$line" =~ ^-[[:space:]]\[.?\] ]]; then
              # Checkbox deÄŸilse ve boÅŸ satÄ±r deÄŸilse iÃ§eriÄŸe ekle
              if [[ -n "$content" ]]; then
                content="$content"$'\n'"$line"
              else
                content="$line"
              fi
            fi
          done <<< "$ISSUE_BODY"
          
          if [[ -n "$current_section" ]]; then
            case "$current_section" in
              "BaÅŸlÄ±k")
                TITLE="$content"
                ;;
              "Tam Tarih (YYYY-AA-GG)")
                DATE="$content"
                ;;
              "Saat (SS:DD) - Ä°steÄŸe baÄŸlÄ±")
                TIME="$content"
                ;;
              "Kategori")
                CATEGORY_MAIN="$content"
                ;;
              "Ã–zel Kategori (EÄŸer 'DiÄŸer' SeÃ§tiyseniz)")
                CATEGORY_OTHER="$content"
                ;;
              "AÃ§Ä±klama")
                DESCRIPTION_RAW="$content"
                ;;
              "Kaynaklar")
                SOURCES_RAW="$content"
                ;;
            esac
          fi
          
          # DeÄŸiÅŸkenleri temizle
          TITLE=$(echo "$TITLE" | tr -d '\r' | xargs)
          DATE=$(echo "$DATE" | tr -d '\r' | xargs)
          TIME=$(echo "$TIME" | tr -d '\r' | xargs)
          CATEGORY_MAIN=$(echo "$CATEGORY_MAIN" | tr -d '\r' | xargs)
          CATEGORY_OTHER=$(echo "$CATEGORY_OTHER" | tr -d '\r' | xargs)
          DESCRIPTION_RAW=$(echo "$DESCRIPTION_RAW" | tr -d '\r')
          SOURCES_RAW=$(echo "$SOURCES_RAW" | tr -d '\r')
          
          # VarsayÄ±lan deÄŸerler
          TITLE="${TITLE:-BaÅŸlÄ±ksÄ±z Olay}"
          DATE="${DATE:-$(date +%Y-%m-%d)}"
          TIME="${TIME:-}"
          CATEGORY_MAIN="${CATEGORY_MAIN:-diÄŸer}"
          CATEGORY_OTHER="${CATEGORY_OTHER:-}"
          DESCRIPTION_RAW="${DESCRIPTION_RAW:-AÃ§Ä±klama eklenmedi}"
          SOURCES_RAW="${SOURCES_RAW:-}"
          
          # Kategori belirle
          if [[ "$CATEGORY_MAIN" == "diÄŸer" && -n "$CATEGORY_OTHER" ]]; then
            CATEGORY="$CATEGORY_OTHER"
          else
            CATEGORY="$CATEGORY_MAIN"
          fi
          
          YEAR=$(echo "$DATE" | cut -d'-' -f1)
          
          # DOSYA ADI BELÄ°RLEME - EN Ã–NEMLÄ° KISIM
          if [[ "$IS_EDIT" == "true" && -n "$ORIGINAL_FILENAME" ]]; then
            # DÃœZENLEME: Mevcut dosya adÄ±nÄ± koru
            FILENAME="$ORIGINAL_FILENAME"
            echo "ğŸ“ DÃ¼zenleme iÅŸlemi: Varolan dosya korunacak - $FILENAME"
          else
            # YENÄ° OLAR: Otomatik dosya adÄ± oluÅŸtur
            SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | \
                   sed -e 's/Ã§/c/g' -e 's/ÄŸ/g/g' -e 's/Ä±/i/g' \
                       -e 's/Ã¶/o/g' -e 's/ÅŸ/s/g' -e 's/Ã¼/u/g' \
                       -e 's/Ã‡/c/g' -e 's/Ä/g/g' -e 's/I/i/g' \
                       -e 's/Ä°/i/g' -e 's/Ã–/o/g' -e 's/Å/s/g' \
                       -e 's/Ãœ/u/g' | \
                   sed -e 's/[^a-z0-9]/-/g' -e 's/--*/-/g' -e 's/^-//' -e 's/-$//')
            FILENAME="${DATE}-${SLUG}.md"
            echo "ğŸ†• Yeni olay: Yeni dosya oluÅŸturulacak - $FILENAME"
          fi
          
          # Ä°Ã§erikleri temizle
          DESCRIPTION_CLEAN=$(echo "$DESCRIPTION_RAW" | sed '/^$/d')
          SOURCES_CLEAN=$(echo "$SOURCES_RAW" | sed '/^$/d')
          
          # "_No response_" olanlarÄ± boÅŸ yap
          if [[ "$TIME" == "_No response_" || "$TIME" == "*No response*" ]]; then
            TIME=""
          fi
          if [[ "$CATEGORY_OTHER" == "_No response_" || "$CATEGORY_OTHER" == "*No response*" ]]; then
            CATEGORY_OTHER=""
          fi
          if [[ "$DESCRIPTION_CLEAN" == "_No response_" || "$DESCRIPTION_CLEAN" == "*No response*" ]]; then
            DESCRIPTION_CLEAN="AÃ§Ä±klama eklenmedi"
          fi
          if [[ "$SOURCES_CLEAN" == "_No response_" || "$SOURCES_CLEAN" == "*No response*" ]]; then
            SOURCES_CLEAN=""
          fi
          
          # GitHub Output'a yaz
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_CLEAN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "category_main=$CATEGORY_MAIN" >> $GITHUB_OUTPUT
          echo "category_other=$CATEGORY_OTHER" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "sources<<EOF" >> $GITHUB_OUTPUT
          echo "$SOURCES_CLEAN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "is_edit=$IS_EDIT" >> $GITHUB_OUTPUT
          echo "original_filename=$ORIGINAL_FILENAME" >> $GITHUB_OUTPUT
          
          # Debug Ã§Ä±ktÄ±larÄ±
          echo "=== PARSED VALUES ==="
          echo "TITLE: $TITLE"
          echo "DATE: $DATE"
          echo "TIME: $TIME"
          echo "CATEGORY: $CATEGORY"
          echo "FILENAME: $FILENAME"
          echo "IS_EDIT: $IS_EDIT"
          echo "ORIGINAL_FILENAME: $ORIGINAL_FILENAME"
          echo "===================="

      - name: Create or update markdown file
        run: |
          mkdir -p events/data
          
          echo "Dosya iÅŸleniyor: events/data/${{ steps.parse.outputs.filename }}"
          
          cat > "events/data/${{ steps.parse.outputs.filename }}" << MDEOF
          ---
          title: "${{ steps.parse.outputs.title }}"
          date: "${{ steps.parse.outputs.date }}"
          time: "${{ steps.parse.outputs.time }}"
          category: "${{ steps.parse.outputs.category_main }}"
          other_category: "${{ steps.parse.outputs.category_other }}"
          ---

          ${{ steps.parse.outputs.description }}

          ## Kaynaklar
          ${{ steps.parse.outputs.sources }}
          MDEOF
          
          echo "âœ… Dosya oluÅŸturuldu/gÃ¼ncellendi: events/data/${{ steps.parse.outputs.filename }}"
          echo "--- DOSYA Ä°Ã‡ERÄ°ÄÄ° ---"
          cat "events/data/${{ steps.parse.outputs.filename }}"
          echo "--- SON ---"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "${{ steps.parse.outputs.is_edit == 'true' && 'ğŸ“ Olay gÃ¼ncelle' || 'âœ¨ Yeni olay ekle' }}: ${{ steps.parse.outputs.title }}"
          branch: event/${{ github.event.issue.number }}
          delete-branch: true
          title: "${{ steps.parse.outputs.is_edit == 'true' && 'ğŸ“ Olay GÃ¼ncelleme' || 'âœ¨ Yeni Olay' }}: ${{ steps.parse.outputs.title }}"
          body: |
            ## ğŸ“… Olay ${{ steps.parse.outputs.is_edit == 'true' && 'GÃ¼ncellendi' || 'Eklendi' }}
            
            **Issue:** #${{ github.event.issue.number }}
            **Dosya:** \`${{ steps.parse.outputs.filename }}\`
            **Tarih:** ${{ steps.parse.outputs.date }}
            **Kategori:** ${{ steps.parse.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak onaylayÄ±n.**
          
          labels: |
            event
            automated
            ${{ steps.parse.outputs.is_edit == 'true' && 'update' || 'new' }}
        id: create-pr

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Issue kapatÄ±ldÄ±. Onay iÃ§in Pull Request oluÅŸturuldu!\n\nğŸ”— **PR:** #${{ steps.create-pr.outputs.pull-request-number }}\nğŸ“ **Dosya:** \`${{ steps.parse.outputs.filename }}\`\n\nâš ï¸ **Not:** PR merge edildikten sonra olay zaman Ã§izelgesinde gÃ¶rÃ¼necektir.`
            })