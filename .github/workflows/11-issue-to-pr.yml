name: 11 - Olay PR Olu≈üturucu (JSON Format)

on:
  issues:
    types: [closed]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Check labels and skip if not supported
        id: check_labels
        run: |
          LABELS_JSON='${{ toJSON(github.event.issue.labels) }}'
          if echo "$LABELS_JSON" | grep -q '"name":"new-event"' || echo "$LABELS_JSON" | grep -q '"name":"upgrade-event"' || echo "$LABELS_JSON" | grep -q '"name":"delete-event"'; then
            echo "continue=true" >> $GITHUB_OUTPUT
          else
            echo "continue=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if not supported label
        if: steps.check_labels.outputs.continue == 'false'
        run: |
          echo "Bu issue desteklenmeyen etiket ta≈üƒ±yor. ƒ∞≈ülem iptal ediliyor."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse JSON data from issue body
        id: parse_json
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "=== ISSUE BODY START ==="
          echo "$ISSUE_BODY"
          echo "=== ISSUE BODY END ==="
          
          # JSON verisini √ßƒ±kar
          JSON_DATA=""
          
          # EVENT JSON verisi - D√úZELTME: Base64'√º doƒüru ≈üekilde √ßƒ±kar
          if echo "$ISSUE_BODY" | grep -q '<!-- EVENT_JSON_DATA_BASE64:'; then
            echo "üì¶ EVENT JSON verisi bulundu"
            # Base64 verisini HTML comment'ten √ßƒ±kar
            BASE64_DATA=$(echo "$ISSUE_BODY" | grep -oP '<!-- EVENT_JSON_DATA_BASE64:\K[^\s]+' | head -1)
            echo "Base64 data: $BASE64_DATA"
            
            # Base64 decode et
            if ! JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null); then
              echo "‚ùå Base64 decode hatasƒ±, alternatif y√∂ntem deneniyor..."
              # Alternatif: Manuel olarak base64 string'ini √ßƒ±kar
              BASE64_DATA=$(echo "$ISSUE_BODY" | sed -n 's/.*EVENT_JSON_DATA_BASE64:\([^[:space:]]*\).*/\1/p')
              JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null)
            fi
            
            if [ -z "$JSON_DATA" ]; then
              echo "‚ùå JSON verisi √ßƒ±karƒ±lamadƒ±"
              exit 1
            fi
            
            OPERATION_TYPE="event"
          
          # DELETE JSON verisi  
          elif echo "$ISSUE_BODY" | grep -q '<!-- DELETE_JSON_DATA_BASE64:'; then
            echo "üóëÔ∏è DELETE JSON verisi bulundu"
            # Base64 verisini HTML comment'ten √ßƒ±kar
            BASE64_DATA=$(echo "$ISSUE_BODY" | grep -oP '<!-- DELETE_JSON_DATA_BASE64:\K[^\s]+' | head -1)
            echo "Base64 data: $BASE64_DATA"
            
            # Base64 decode et
            if ! JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null); then
              echo "‚ùå Base64 decode hatasƒ±, alternatif y√∂ntem deneniyor..."
              # Alternatif: Manuel olarak base64 string'ini √ßƒ±kar
              BASE64_DATA=$(echo "$ISSUE_BODY" | sed -n 's/.*DELETE_JSON_DATA_BASE64:\([^[:space:]]*\).*/\1/p')
              JSON_DATA=$(echo "$BASE64_DATA" | base64 -d 2>/dev/null)
            fi
            
            if [ -z "$JSON_DATA" ]; then
              echo "‚ùå JSON verisi √ßƒ±karƒ±lamadƒ±"
              exit 1
            fi
            
            OPERATION_TYPE="delete"
          
          else
            echo "‚ùå JSON verisi bulunamadƒ±"
            echo "OPERATION_TYPE=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üìÑ JSON Data: $JSON_DATA"
          
          # jq ile parse et
          TITLE=$(echo "$JSON_DATA" | jq -r '.title // ""')
          DATE=$(echo "$JSON_DATA" | jq -r '.date // ""')
          TIME=$(echo "$JSON_DATA" | jq -r '.time // ""')
          CATEGORY=$(echo "$JSON_DATA" | jq -r '.category // ""')
          DESCRIPTION=$(echo "$JSON_DATA" | jq -r '.description // ""')
          SOURCES=$(echo "$JSON_DATA" | jq -r '.sources // ""')
          TYPE=$(echo "$JSON_DATA" | jq -r '.type // ""')
          ORIGINAL_FILENAME=$(echo "$JSON_DATA" | jq -r '.original_filename // ""')
          FILENAME_TO_DELETE=$(echo "$JSON_DATA" | jq -r '.filename // ""')
          
          # Varsayƒ±lan deƒüerler
          TITLE="${TITLE:-Ba≈ülƒ±ksƒ±z Olay}"
          DATE="${DATE:-$(date +%Y-%m-%d)}"
          CATEGORY="${CATEGORY:-diƒüer}"
          DESCRIPTION="${DESCRIPTION:-A√ßƒ±klama eklenmedi}"
          SOURCES="${SOURCES:-}"
          
          # Dosya adƒ± olu≈ütur
          if [[ "$OPERATION_TYPE" == "event" ]]; then
            if [[ "$TYPE" == "edit" && -n "$ORIGINAL_FILENAME" ]]; then
              FILENAME="$ORIGINAL_FILENAME"
              echo "üìù D√ºzenleme i≈ülemi: $FILENAME"
            else
              SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | \
                     sed -e 's/√ß/c/g' -e 's/ƒü/g/g' -e 's/ƒ±/i/g' \
                         -e 's/√∂/o/g' -e 's/≈ü/s/g' -e 's/√º/u/g' \
                         -e 's/√á/c/g' -e 's/ƒû/g/g' -e 's/I/i/g' \
                         -e 's/ƒ∞/i/g' -e 's/√ñ/o/g' -e 's/≈û/s/g' \
                         -e 's/√ú/u/g' | \
                     sed -e 's/[^a-z0-9]/-/g' -e 's/--*/-/g' -e 's/^-//' -e 's/-$//')
              FILENAME="${DATE}-${SLUG}.md"
              echo "üÜï Yeni olay: $FILENAME"
            fi
          elif [[ "$OPERATION_TYPE" == "delete" ]]; then
            FILENAME="$FILENAME_TO_DELETE"
            echo "üóëÔ∏è Silinecek dosya: $FILENAME"
          fi
          
          # GitHub Output'a yaz
          echo "OPERATION_TYPE=$OPERATION_TYPE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "sources<<EOF" >> $GITHUB_OUTPUT
          echo "$SOURCES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "original_filename=$ORIGINAL_FILENAME" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          
          echo "=== PARSED VALUES ==="
          echo "OPERATION_TYPE: $OPERATION_TYPE"
          echo "TITLE: $TITLE"
          echo "DATE: $DATE"
          echo "CATEGORY: $CATEGORY"
          echo "FILENAME: $FILENAME"
          echo "TYPE: $TYPE"
          echo "===================="

      - name: Create or update event file
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event'
        run: |
          mkdir -p events/data
          
          echo "Dosya i≈üleniyor: events/data/${{ steps.parse_json.outputs.filename }}"
          
          cat > "events/data/${{ steps.parse_json.outputs.filename }}" << MDEOF
          ---
          title: "${{ steps.parse_json.outputs.title }}"
          date: "${{ steps.parse_json.outputs.date }}"
          time: "${{ steps.parse_json.outputs.time }}"
          category: "${{ steps.parse_json.outputs.category }}"
          ---

          ${{ steps.parse_json.outputs.description }}

          ## Kaynaklar
          ${{ steps.parse_json.outputs.sources }}
          MDEOF
          
          echo "‚úÖ Dosya olu≈üturuldu/g√ºncellendi: events/data/${{ steps.parse_json.outputs.filename }}"
          echo "--- DOSYA ƒ∞√áERƒ∞ƒûƒ∞ ---"
          cat "events/data/${{ steps.parse_json.outputs.filename }}"
          echo "--- SON ---"

      - name: Delete event file
        if: steps.parse_json.outputs.OPERATION_TYPE == 'delete'
        run: |
          echo "Silinecek dosya: events/data/${{ steps.parse_json.outputs.filename }}"
          
          if [ -f "events/data/${{ steps.parse_json.outputs.filename }}" ]; then
            rm "events/data/${{ steps.parse_json.outputs.filename }}"
            echo "‚úÖ Dosya silindi: events/data/${{ steps.parse_json.outputs.filename }}"
          else
            echo "‚ùå Dosya bulunamadƒ±: events/data/${{ steps.parse_json.outputs.filename }}"
            exit 1
          fi

      - name: Create Pull Request for Edit Event
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event' && steps.parse_json.outputs.type == 'edit'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "üìù Olay g√ºncelle: ${{ steps.parse_json.outputs.title }}"
          branch: update-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "üìù Olay G√ºncelleme: ${{ steps.parse_json.outputs.title }}"
          body: |
            ## üìÖ Olay G√ºncellendi
            
            **Issue:** #${{ github.event.issue.number }}
            **Dosya:** `${{ steps.parse_json.outputs.filename }}`
            **Tarih:** ${{ steps.parse_json.outputs.date }}
            **Kategori:** ${{ steps.parse_json.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatƒ±ldƒ±ƒüƒ± i√ßin) tarafƒ±ndan otomatik olarak olu≈üturuldu.
            
            **L√ºtfen "Merge pull request" butonuna basarak onaylayƒ±n.**
          labels: |
            event
            automated
            update

      - name: Create Pull Request for New Event
        if: steps.parse_json.outputs.OPERATION_TYPE == 'event' && steps.parse_json.outputs.type != 'edit'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "‚ú® Yeni olay ekle: ${{ steps.parse_json.outputs.title }}"
          branch: new-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "‚ú® Yeni Olay: ${{ steps.parse_json.outputs.title }}"
          body: |
            ## üìÖ Olay Eklendi
            
            **Issue:** #${{ github.event.issue.number }}
            **Dosya:** `${{ steps.parse_json.outputs.filename }}`
            **Tarih:** ${{ steps.parse_json.outputs.date }}
            **Kategori:** ${{ steps.parse_json.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatƒ±ldƒ±ƒüƒ± i√ßin) tarafƒ±ndan otomatik olarak olu≈üturuldu.
            
            **L√ºtfen "Merge pull request" butonuna basarak onaylayƒ±n.**
          labels: |
            event
            automated
            new

      - name: Create Pull Request for Delete
        if: steps.parse_json.outputs.OPERATION_TYPE == 'delete'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "üóëÔ∏è Olay sil: ${{ steps.parse_json.outputs.filename }}"
          branch: delete-event-${{ github.event.issue.number }}
          delete-branch: true
          title: "üóëÔ∏è Olay Sil: ${{ steps.parse_json.outputs.filename }}"
          body: |
            ## ‚õî Olay Silme ƒ∞steƒüi
            
            **Issue:** #${{ github.event.issue.number }}
            **Silinen Dosya:** `${{ steps.parse_json.outputs.filename }}`
            
            ---
            ‚ö†Ô∏è **Dƒ∞KKAT:** Bu i≈ülem geri alƒ±namaz!
            
            Bu PR, issue #${{ github.event.issue.number }} (kapatƒ±ldƒ±ƒüƒ± i√ßin) tarafƒ±ndan otomatik olarak olu≈üturuldu.
            
            **L√ºtfen "Merge pull request" butonuna basarak silme i≈ülemini onaylayƒ±n.**
          labels: |
            event
            deletion
            automated

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const operationType = '${{ steps.parse_json.outputs.OPERATION_TYPE }}';
            const eventType = '${{ steps.parse_json.outputs.type }}';
            
            let prNumber;
            let message;
            
            if (operationType === 'event') {
              if (eventType === 'edit') {
                message = `‚úÖ Issue kapatƒ±ldƒ±. Olay g√ºncelleme i√ßin Pull Request olu≈üturuldu!\n\nüìÅ **Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
              } else {
                message = `‚úÖ Issue kapatƒ±ldƒ±. Yeni olay i√ßin Pull Request olu≈üturuldu!\n\nüìÅ **Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
              }
            } else {
              message = `‚úÖ Issue kapatƒ±ldƒ±. Silme i≈ülemi i√ßin Pull Request olu≈üturuldu!\n\nüóëÔ∏è **Silinen Dosya:** \`${{ steps.parse_json.outputs.filename }}\``;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });