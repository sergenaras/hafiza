name: 11 - Issue √ºzerinden olay olu≈ütur.

on:
  issues:
    types: [labeled]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'new-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        run: |
          # Get issue body
          ISSUE_BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          
          # Yeni ≈üablona g√∂re parse et (Artƒ±k 'year' yok, 'date' ve 'sources' var)
          TITLE=$(echo "$ISSUE_BODY" | awk '/### Ba≈ülƒ±k/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          DATE=$(echo "$ISSUE_BODY" | awk '/### Tam Tarih/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          CATEGORY=$(echo "$ISSUE_BODY" | awk '/### Kategori/{getline; while($0 ~ /^[[:space:]]*$/){getline}; print}' | tr -d '\r')
          DESCRIPTION=$(echo "$ISSUE_BODY" | awk '/### A√ßƒ±klama/{f=1;next} /### Kaynaklar/{f=0} f' | sed '/^[[:space:]]*$/d' | tr -d '\r')
          SOURCES=$(echo "$ISSUE_BODY" | awk '/### Kaynaklar/{f=1;next} /### Doƒürulama Kontrol Listesi/{f=0} f' | sed '/^[[:space:]]*$/d' | tr -d '\r')

          # Yƒ±lƒ±, 'date' alanƒ±ndan al (YYYY-AA-GG)
          YEAR=$(echo "$DATE" | cut -d'-' -f1)
          
          # Dosya adƒ± i√ßin ba≈ülƒ±ƒüƒ± temizle
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9√ßƒüƒ±√∂≈ü√º]/-/g' | sed 's/--\+/-/g' | sed 's/^-//' -e 's/-$//')
          FILENAME="${YEAR}-${SLUG}.md"
          
          # √áƒ±ktƒ±larƒ± ayarla
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "sources<<EOF" >> $GITHUB_OUTPUT
          echo "$SOURCES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          
          echo "üìã Parsed:"
          echo "  Year: $YEAR"
          echo "  Title: $TITLE"
          echo "  Category: $CATEGORY"
          echo "  Date: $DATE"
          echo "  Filename: $FILENAME"

      - name: Create markdown file
        run: |
          mkdir -p events/data
          
          # Yeni ≈üablona g√∂re .md dosyasƒ±nƒ± olu≈ütur
          cat > "events/data/${{ steps.parse.outputs.filename }}" << 'MDEOF'
          ---
          title: "${{ steps.parse.outputs.title }}"
          date: ${{ steps.parse.outputs.date }}
          category: ${{ steps.parse.outputs.category }}
          ---
          
          ${{ steps.parse.outputs.description }}

          ## Kaynaklar
          ${{ steps.parse.outputs.sources }}
          MDEOF
          
          echo "‚úÖ Created: events/data/${{ steps.parse.outputs.filename }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Yeni olay ekle: ${{ steps.parse.outputs.title }} (${{ steps.parse.outputs.year }})"
          branch: event/${{ github.event.issue.number }}
          delete-branch: true
          title: "‚ú® Yeni Olay: ${{ steps.parse.outputs.title }}"
          body: |
            ## üìÖ Yeni Olay Eklendi
            
            **Issue:** #${{ github.event.issue.number }}
            **Tarih:** ${{ steps.parse.outputs.date }}
            **Kategori:** ${{ steps.parse.outputs.category }}
            
            ### üìñ A√ßƒ±klama
            ${{ steps.parse.outputs.description }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} tarafƒ±ndan otomatik olarak olu≈üturuldu.
            
            **L√ºtfen "Merge pull request" butonuna basarak onaylayƒ±n.**
          labels: |
            event
            automated
        id: create-pr

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üéâ Olayƒ±nƒ±z i√ßin bir Pull Request olu≈üturuldu!\n\nüîó **PR:** #${{ steps.create-pr.outputs.pull-request-number }}\n\nL√ºtfen PR'ƒ± inceleyip onaylayƒ±n (Merge edin).`
            })