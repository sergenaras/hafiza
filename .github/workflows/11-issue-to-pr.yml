name: 11 - Olay PR OluÅŸturucu (Yeni/DÃ¼zenle)

on:
  issues:
    types: [closed]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'new-event') || contains(github.event.issue.labels.*.name, 'upgrade-event')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Bu 'awk' komutu, GitHub'Ä±n "**Label:**\n\nValue" formatÄ±nÄ± 'LABEL=Value' formatÄ±na Ã§evirir
          parsed_data=$(echo "$ISSUE_BODY" | awk -F'\n\n' '
            BEGIN { RS = "\n\n" }
            {
              if (match($0, /^\*\*([^*]+)\*\*/, label)) {
                gsub(/\r$/, "", $0); 
                current_label = label[1];
                sub( /^\*\*([^*]+)\*\*\s*/, "");
                
                if (match($0, /^- \[ \]/) || match($0, /^- \[x\]/i)) {
                    value=""
                    n_opts = split($0, opts, "\n- ");
                    for (i=1; i<=n_opts; i++) {
                        value = value opts[i] "\n"
                    }
                } else {
                    value = $0;
                }
                
                gsub(/'/, "\\&apos;", value);
                gsub(/"/, "\\&quot;", value);
                
                if (current_label == "BaÅŸlÄ±k") key="TITLE";
                else if (current_label == "Tam Tarih (YYYY-AA-GG)") key="DATE";
                else if (current_label == "Saat (SS:DD) - Ä°steÄŸe baÄŸlÄ±") key="TIME";
                else if (current_label == "Kategori") key="CATEGORY_MAIN";
                else if (current_label == "Ã–zel Kategori (EÄŸer 'DiÄŸer' SeÃ§tiyseniz)") key="CATEGORY_OTHER";
                else if (current_label == "AÃ§Ä±klama") key="DESCRIPTION_RAW";
                else if (current_label == "Kaynaklar") key="SOURCES_RAW";
                else key="UNKNOWN";
                
                if (key != "UNKNOWN") {
                    printf "%s=%s\n", key, value
                }
              }
            }
          ')

          echo "$parsed_data" >> $GITHUB_ENV
          
          TITLE="${TITLE:-_No response_}"
          DATE="${DATE:-_No response_}"
          TIME="${TIME:-_No response_}"
          CATEGORY_MAIN="${CATEGORY_MAIN:-_No response_}"
          CATEGORY_OTHER="${CATEGORY_OTHER:-_No response_}"
          DESCRIPTION_RAW="${DESCRIPTION_RAW:-_No response_}"
          SOURCES_RAW="${SOURCES_RAW:-_No response_}"

          if [[ "$CATEGORY_MAIN" == "diÄŸer" && -n "$CATEGORY_OTHER" && "$CATEGORY_OTHER" != "_No response_" ]]; then
            CATEGORY="$CATEGORY_OTHER"
          else
            CATEGORY="$CATEGORY_MAIN"
          fi

          YEAR=$(echo "$DATE" | cut -d'-' -f1)
          
          # --- DÃœZELTÄ°LDÄ°: Gizli etiketi ('') ara ---
          ORIGINAL_FILENAME=$(echo "$ISSUE_BODY" | grep -o '' | sed -e 's///' | tr -d '\r\n')
          
          IS_EDIT="false"
          
          if [[ -n "$ORIGINAL_FILENAME" ]]; then
            IS_EDIT="true"
            FILENAME="$ORIGINAL_FILENAME"
            echo "Ä°ÅŸlem: DÃ¼zenleme. Varolan dosyanÄ±n Ã¼zerine yazÄ±lacak: $FILENAME"
          else
            IS_EDIT="false"
            SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/-/g' -e 's/--\+/-/g' -e 's/^-//' -e 's/-$//')
            FILENAME="${DATE}-${SLUG}.md" 
            echo "Ä°ÅŸlem: Yeni Olay. Yeni dosya oluÅŸturulacak: $FILENAME"
          fi
          
          # --- DÃœZELTÄ°LDÄ°: Gizli etiketi metinden temizle ---
          DESCRIPTION_CLEAN=$(echo "$DESCRIPTION_RAW" | sed 's///g' | sed '/^$/N;/\n$/D')
          SOURCES_CLEAN=$(echo "$SOURCES_RAW" | sed 's///g' | sed '/^$/N;/\n$/D')
          
          # '_No response_' olanlarÄ± boÅŸ string yap
          [ "$TIME" == "_No response_" ] && TIME=""
          [ "$CATEGORY_OTHER" == "_No response_" ] && CATEGORY_OTHER=""
          [ "$DESCRIPTION_CLEAN" == "_No response_" ] && DESCRIPTION_CLEAN=""
          [ "$SOURCES_CLEAN" == "_No response_" ] && SOURCES_CLEAN=""

          # Ã‡Ä±ktÄ±larÄ± ayarla
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_CLEAN" >> $GITHUB_OUTPUT 
          echo "EOF" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "category_main=$CATEGORY_MAIN" >> $GITHUB_OUTPUT
          echo "category_other=$CATEGORY_OTHER" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT 
          echo "sources<<EOF" >> $GITHUB_OUTPUT
          echo "$SOURCES_CLEAN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT 
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "is_edit=$IS_EDIT" >> $GITHUB_OUTPUT

      - name: Create markdown file
        run: |
          mkdir -p events/data
          cat > "events/data/${{ steps.parse.outputs.filename }}" << 'MDEOF'
          ---
          title: "${{ steps.parse.outputs.title }}"
          date: ${{ steps.parse.outputs.date }}
          time: ${{ steps.parse.outputs.time }}
          category: ${{ steps.parse.outputs.category_main }}
          other_category: ${{ steps.parse.outputs.category_other }}
          ---
          
          ${{ steps.parse.outputs.description }}

          ## Kaynaklar
          ${{ steps.parse.outputs.sources }}
          MDEOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "${{ steps.parse.outputs.is_edit == 'true' && 'OlayÄ± gÃ¼ncelle' || 'Yeni olay ekle' }}: ${{ steps.parse.outputs.title }}"
          branch: event/${{ github.event.issue.number }}
          delete-branch: true
          title: "${{ steps.parse.outputs.is_edit == 'true' && 'ðŸ”„ Olay GÃ¼ncelleme' || 'âœ¨ Yeni Olay' }}: ${{ steps.parse.outputs.title }}"
          body: |
            ## ðŸ“… Olay ${{ steps.parse.outputs.is_edit == 'true' && 'GÃ¼ncellendi' || 'Eklendi' }}
            
            **Issue:** #${{ github.event.issue.number }}
            **Tarih:** ${{ steps.parse.outputs.date }}
            **Kategori:** ${{ steps.parse.outputs.category }}
            
            ---
            Bu PR, issue #${{ github.event.issue.number }} (kapatÄ±ldÄ±ÄŸÄ± iÃ§in) tarafÄ±ndan otomatik olarak oluÅŸturuldu.
            
            **LÃ¼tfen "Merge pull request" butonuna basarak onaylayÄ±n.**
          
          labels: |
            event
            automated
            ${{ steps.parse.outputs.is_edit == 'true' && 'update' || 'new' }}
        id: create-pr

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Issue kapatÄ±ldÄ±. Onay iÃ§in Pull Request oluÅŸturuldu!\n\nðŸ”— **PR:** #${{ steps.create-pr.outputs.pull-request-number }}`
            })